stages:
  - .pre
  - test
  - deploy

prepare:install-node:
  stage: .pre
  image: node:16
  cache:
    key: modules
    paths:
      - node_modules/
  before_script:
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
    ## Make sure that ssh will trust the new host, instead of asking
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
    - if [[ ! -d node_modules ]] || [[ -n `git diff --name-only HEAD~1 HEAD | grep "\package.json\b"` ]];
      then
      npm ci;
      fi



test:
  stage: test
  image: cypress/base:14.16.0
  script:
    - npm ci --prefer-offline
    - npm start &
    - npx cypress run

deploy:
  stage: deploy
  script:
    - echo "Prueba de deploy"
